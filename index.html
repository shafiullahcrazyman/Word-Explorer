<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Word Explorer by Shafiullah</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon.png">
  <link rel="icon" href="icon.png">
  <meta name="theme-color" content="#0F172A">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Word Explorer">
  <style>
    :root {
      --accent: #0078ff;
      --fallback: #f97316;
    }

    @media (prefers-color-scheme: dark) {
      body { background: #0f172a; color: #f1f5f9; }
      input { background: #1e293b; color: #f1f5f9; border-color: #334155; }
      .result { background: #1e293b; color: #f1f5f9; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); }
      .word-section { border-left: 4px solid var(--accent); }
      .history-item { background: #334155; }
      .history-item:hover { background: #475569; }
      .example { color: #94a3b8; }
      .clear-history-button { color: var(--accent); }
      .motivational-quote { color: #94a3b8; }
      .inflection-tag { background: #334155; border: 1px solid #475569; color: #aebecd; }
      .base-form-note, .no-entry-note { font-style: italic; margin-top: 5px; color: #94a3b8; font-size: 0.9em; }
      .definition-item::before { content: '•'; color: #ffffff; }
      .skeleton-line { background-color: #334155; box-shadow: 0 0 50px 10px #1e293b; }
      .skeleton-bullet { background-color: #475569; }
      .read-aloud-btn { color: #f1f5f9; background: #334155; }
      .read-aloud-btn:hover:not(:disabled) { background: #475569; }
      .read-aloud-btn:disabled { color: #94a3b8; opacity: 0.7; cursor: wait; }
      .read-aloud-btn.speaking { background: var(--accent) !important; color: white !important; }
    }

    @media (prefers-color-scheme: light) {
      body { background: #f7f9fc; color: #222; }
      input { background: #fff; color: #000; border-color: #ccc; }
      .result { background: #fff; color: #000; }
      .word-section { border-left: 4px solid var(--accent); }
      .history-item { background: #e2e8f0; }
      .history-item:hover { background: #cbd5e1; }
      .example { color: #475569; }
      .clear-history-button { color: var(--accent); }
      .motivational-quote { color: #475569; }
      .inflection-tag { background: #e2e8f0; border: 1px solid #cbd5e1; color: #64748b; }
      .base-form-note, .no-entry-note { font-style: italic; margin-top: 5px; color: #475569; font-size: 0.9em; }
      .definition-item::before { content: '•'; color: var(--accent); }
      .skeleton-line { background-color: #e2e8f0; box-shadow: 0 0 50px 10px #fff; }
      .skeleton-bullet { background-color: #cbd5e1; }
      .read-aloud-btn { color: #334155; background: #e2e8f0; }
      .read-aloud-btn:hover:not(:disabled) { background: #cbd5e1; }
      .read-aloud-btn:disabled { color: #94a3b8; opacity: 0.7; cursor: wait; }
      .read-aloud-btn.speaking { background: var(--accent) !important; color: white !important; }
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center;
    }
    h1 { font-size: 1.6em; margin-bottom: 10px; text-align: center; color: var(--accent); }
    .search-container { position: relative; width: 90%; max-width: 480px; margin-bottom: 15px; }
    input {
      width: 100%; padding: 10px 50px 10px 15px; font-size: 1em; border: 2px solid var(--accent);
      border-radius: 15px; outline: none; box-sizing: border-box; transition: border-color 0.3s;
    }
    button { cursor: pointer; }
    .search-button {
      position: absolute; right: 6px; top: 6px; bottom: 6px; width: 40px; background: var(--accent);
      color: white; border: none; padding: 0; border-radius: 10px; font-size: 1em; font-weight: 600;
      display: flex; align-items: center; justify-content: center; transition: background 0.3s;
    }
    .search-button:hover { opacity: 0.9; }
    .result {
      margin-top: 20px; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      width: 90%; max-width: 480px; transition: 0.3s;
    }
    .word-section { margin-bottom: 20px; padding-left: 15px; }
    .word-section:last-child { margin-bottom: 0; }
    .word-section h3 { margin: 5px 0 10px 0; color: var(--accent); font-size: 1.1em; transition: color 0.3s; }
    .section-header { display: flex; align-items: center; justify-content: space-between; margin: 5px 0 10px 0; }
    .section-header h3 { margin: 0; color: var(--accent); font-size: 1.1em; }
    .read-aloud-btn {
      border: none; padding: 6px 8px; border-radius: 8px; transition: background 0.2s, opacity 0.2s;
      display: flex; align-items: center; justify-content: center; gap: 5px; font-size: 0.85em;
      font-weight: 500; outline: none;
    }
    .read-aloud-btn.speaking { background: var(--accent) !important; color: white !important; }
    .definition { margin-top: 5px; }
    .definition-item {
      margin-top: 0; margin-bottom: 12px; position: relative; padding-left: 20px; line-height: 1.4;
    }
    .definition-item::before { position: absolute; left: 0; top: 0; font-size: 1.2em; font-weight: bold; }
    .example { margin-left: 0; font-style: italic; display: block; padding-top: 5px; }
    .related { background: rgba(0, 120, 255, 0.1); border-radius: 10px; padding: 10px 15px; font-size: 0.95em; line-height: 1.6; }
    #inflections {
      margin: 10px 0 20px 0; padding: 10px 0; border-top: 1px solid rgba(128, 128, 128, 0.2);
      border-bottom: 1px solid rgba(128, 128, 128, 0.2); display: flex; flex-wrap: wrap; gap: 8px; font-size: 0.9em;
    }
    .inflection-tag {
      padding: 4px 8px; border-radius: 6px; font-weight: 500; display: inline-flex; align-items: center; gap: 4px;
    }
    .inflection-tag .inflection-label { font-weight: normal; opacity: 0.8; margin-right: 4px; text-transform: capitalize; }
    audio { margin-top: 10px; width: 100%; border-radius: 50px; }
    .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .history-header h3 { margin: 0; color: var(--accent); }
    .clear-history-button {
      background: none; border: none; font-size: 0.9em; text-decoration: none; width: 32px; height: 32px;
      border-radius: 50%; display: flex; align-items: center; justify-content: center; padding: 0;
    }
    .clear-history-button:hover { opacity: 1; background-color: rgba(128, 128, 128, 0.15); }
    #history-container h3 { margin-top: 0; margin-bottom: 10px; color: var(--accent); }
    #history { display: flex; flex-wrap: wrap; gap: 8px; }
    .history-item { padding: 5px 12px; border-radius: 16px; font-size: 0.9em; cursor: pointer; transition: background-color 0.2s; }
    #initial-state { display: flex; flex-direction: column; align-items: center; margin-top: 40px; padding: 0 20px; text-align: center; }
    #initial-state img { width: 150px; height: 150px; border-radius: 50%; border: 4px solid var(--accent); object-fit: cover; margin-bottom: 20px; }
    .motivational-quote { font-style: italic; font-size: 1.1em; max-width: 400px; }
    @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1.0; } 100% { opacity: 0.6; } }
    .skeleton-screen { animation: pulse 1.5s infinite ease-in-out; width: 100%; }
    .skeleton-line { height: 14px; margin-bottom: 8px; border-radius: 4px; }
    .skeleton-title { height: 20px; width: 60%; margin: 5px 0 10px 0; border-radius: 6px; }
    .skeleton-big-text { height: 24px; width: 70%; margin-bottom: 15px; border-radius: 6px; }
    .skeleton-definition-item { display: flex; align-items: flex-start; margin-bottom: 12px; }
    .skeleton-bullet { width: 8px; height: 8px; min-width: 8px; border-radius: 50%; margin-right: 12px; margin-top: 3px; }
    .skeleton-text-container { flex-grow: 1; }
    .dictionary-missing { border-left-color: #f97316 !important; }
    .translate-toggle {
      color: var(--accent); cursor: pointer; font-size: 0.9em; margin-top: 6px; user-select: none; transition: opacity 0.2s;
    }
    .translate-toggle:hover { opacity: 0.7; }
    .bengali-translation { background: rgba(0, 120, 255, 0.05); padding: 8px 12px; border-radius: 8px; }
    .pre-wrap-content { white-space: pre-wrap; padding-left: 5px; }
  </style>
</head>
<body>
  <h1>Word Explorer</h1>
  <div class="search-container">
    <input type="text" id="wordInput" placeholder="Enter a word (e.g., explorer)" onkeydown="if(event.key==='Enter') findWordFamily()" />
    <button class="search-button" onclick="findWordFamily()" aria-label="Search">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="8"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>
    </button>
  </div>
  <div id="initial-state" style="display: none;">
    <div id="tutorial-container" style="position:relative; width:150px; height:150px; border-radius:50%; overflow:hidden; border:4px solid var(--accent);">
      <iframe id="tutorial-video" 
              src="https://streamable.com/e/zl6p48?autoplay=1&nocontrols=1&muted=1&loop=0" 
              allow="autoplay; fullscreen" 
              style="width:100%; height:100%; border:none; border-radius:50%; object-fit:cover;">
      </iframe>

      <button id="mute-toggle" 
              style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:rgba(0,0,0,0.6); border:none; border-radius:50%; width:150px; height:150px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:opacity 0.3s;">
        <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M11 5L6 9H2v6h4l5 4V5z"></path>
          <line x1="23" y1="9" x2="17" y2="15"></line>
          <line x1="17" y1="9" x2="23" y2="15"></line>
        </svg>
      </button>
    </div>
    <p id="img-error" style="display:none; color: red;">Could not load profile image.</p>
    <p class="motivational-quote">"Every word you learn is a new world you discover. Start exploring!"</p>
  </div>
  <div id="history-container" class="result" style="display:none; padding: 15px 20px;">
    <div class="history-header">
      <h3>Search History</h3>
      <button class="clear-history-button" onclick="clearHistory()" aria-label="Clear history">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="3 6 5 6 21 6"></polyline>
          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
          <line x1="10" y1="11" x2="10" y2="17"></line>
          <line x1="14" y1="11" x2="14" y2="17"></line>
        </svg>
      </button>
    </div>
    <div id="history"></div>
  </div>
  <div id="results" class="result" style="display:none;"></div>

  <script>
    window.onload = loadHistory;
    const API_URL_DICT = "https://api.dictionaryapi.dev/api/v2/entries/en/";
    const API_URL_DM = "https://api.datamuse.com/words";
    
    const API_KEYS = [
        "AIzaSyCy95KSMP09eDWaPtB7E3NM_4kE4MLDluI",
        "AIzaSyD_pdqzjsoXZxcICYGiPNuuN5ubKpDxq9w", 
        "AIzaSyA8JHXKVUC2PzE4iSVicPa8d02AgNIydRQ", 
        "AIzaSyCjIbsyKxOLl0CZfSH8OUpZ8O7nafrjpmI", 
        "AIzaSyBSbH0rbGi22WMlzRrujEjW0lRymDUOnlo"  
    ];
    const API_BASE_URL_GEMINI = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=`;

    let currentButton = null;
    let rawTextsForTTS = {};
    let browserVoices = [];
    let isBrowserVoiceReady = false;
    
    if (window.speechSynthesis) {
        window.speechSynthesis.onvoiceschanged = () => {
            browserVoices = window.speechSynthesis.getVoices();
            isBrowserVoiceReady = true;
            console.log("Browser voices loaded.");
        };
    } else {
        console.warn("Web Speech API not supported.");
    }
    
    function getSpeakerIconHtml() {
        return `
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 5L6 9H2v6h4l5 4V5z"/>
                <path d="M15.54 8.46a4.99 4.99 0 0 1 0 7.07"/>
                <path d="M19.07 4.93a10 10 0 0 1 0 14.14"/>
            </svg>
        `;
    }

    function getStopIconHtml() {
        return `
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="6" y="4" width="4" height="16"/>
                <rect x="14" y="4" width="4" height="16"/>
            </svg>
        `;
    }

    function resetButtonVisuals(button) {
        if (button && button.classList.contains('read-aloud-btn')) {
            button.classList.remove('speaking');
            button.innerHTML = getSpeakerIconHtml();
            button.disabled = false;
        }
    }
    
    function getBrowserVoice(lang) {
        if (!isBrowserVoiceReady) return null;
        if (lang === 'en') {
            const englishVoices = browserVoices.filter(v => v.lang.toLowerCase().includes('en-gb'));
            const female = englishVoices.find(v => v.name.toLowerCase().includes('female'));
            return female || englishVoices[0] || null;
        }
        if (lang === 'bn') {
            const bengaliVoices = browserVoices.filter(v => v.lang.toLowerCase().includes('bn'));
            const female = bengaliVoices.find(v => v.name.toLowerCase().includes('female'));
            return female || bengaliVoices[0] || null;
        }
        return null;
    }

    function readAloudBrowser(text, lang, buttonElement) {
        if (!text || text.includes("N/A") || text.includes("Could not retrieve")) return;

        if (window.speechSynthesis.speaking) {
            window.speechSynthesis.cancel();
            if (currentButton) { 
                resetButtonVisuals(currentButton); 
            }
            if (currentButton === buttonElement) {
                currentButton = null;
                return;
            }
        }
        
        currentButton = buttonElement;

        if (currentButton) {
            currentButton.classList.add('speaking');
            currentButton.innerHTML = getStopIconHtml();
        }

        text = text.replace(/<[^>]*>/g, '').replace(/\*/g, '').replace(/[#_]/g, '').trim();

        const utterance = new SpeechSynthesisUtterance(text);
        const voice = getBrowserVoice(lang);
        if (voice) {
            utterance.voice = voice;
            utterance.lang = voice.lang;
        } else {
             utterance.lang = lang === 'en' ? 'en-US' : 'bn-IN';
        }
        
        utterance.onend = () => {
            resetButtonVisuals(buttonElement);
            currentButton = null;
        };
        utterance.onerror = (e) => {
            console.error("SpeechSynthesis Error:", e);
            resetButtonVisuals(buttonElement);
            currentButton = null;
        };

        window.speechSynthesis.speak(utterance);
    }
    
    async function callGemini(prompt, systemInstruction, useGrounding = false) {
      const payload = {
        contents: [{ parts: [{ text: prompt }] }],
        systemInstruction: { parts: [{ text: systemInstruction }] },
      };
      if (useGrounding) {
        payload.tools = [{ "google_search": {} }];
      }
      
      for (const key of API_KEYS) {
        try {
          const response = await fetch(API_BASE_URL_GEMINI + key, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (response.ok) {
            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            return text || "N/A";
          } else {
            console.warn(`Gemini API key ending in ${key.slice(-4)} failed with status ${response.status}. Trying next key...`);
          }
        } catch (error) {
          console.error(`Network error with key ending in ${key.slice(-4)}:`, error.message);
        }
      }
      
      return "Could not retrieve detailed information. (All keys failed)";
    }
    
    async function getWordSummary(word) {
      const systemPrompt = "Act as a concise dictionary assistant. Provide a single, short sentence (under 20 words) that captures the central, most common meaning of the user's provided word. Do not include any introductory phrases, just the definition.";
      return callGemini(word, systemPrompt, true); 
    }

    async function getWordEtymology(word) {
      const systemPrompt = "Act as a historical linguist. Provide a brief, single-paragraph (2-3 sentences max) explanation of the etymology (history and origin) of the user's provided word. Focus on the language of origin and its historical development. Start with 'The word...'";
      return callGemini(word, systemPrompt, true);
    }
    
    async function getGrammarSummary(word) {
        const systemPrompt = "Act as an advanced English grammar tutor. For the given word, provide a deep analysis of its grammatical usage in a single, well-structured paragraph. Focus on the following points: 1. Transitivity (if a verb) or Countability (if a noun). 2. Common prepositions or phrases it pairs with (collocations). 3. Any irregular forms or common grammatical errors made when using this word. Use clear, educational language. For example, if the word is 'advice', explain that it is an uncountable noun and should not be pluralized with 's'.";
        return callGemini(word, systemPrompt, true);
    }

    async function getWordFamilyForms(word) {
        const systemPrompt = `Act as an advanced English lexicographer. For the given word, generate a concise, structured list of its complete word family, including various forms for different parts of speech. Follow this structure strictly:
1.  **If the word is an adjective or has an adjective form:** Provide the positive, comparative, and superlative forms (e.g., big, bigger, biggest).
2.  **If the word is a verb or has a verb form:** Provide the base form (infinitive), simple past, past participle, and present participle (e.g., go, went, gone, going).
3.  **If the word is a noun or has a noun form:** Provide the singular and plural forms (e.g., dog, dogs).
4.  **If the word is an adverb or has an adverb form:** Provide the base form and its degree forms if applicable (e.g., quickly, more quickly, most quickly).
Output the response as a single, plain text string using Markdown lists with bold headings. If no forms are found, return 'N/A'. Do not include any introductory or concluding sentences.`;
        return callGemini(word, systemPrompt, true);
    }
    
    async function getBengaliTranslation(text) {
     if (!text || text.includes("N/A") || text.includes("Could not retrieve")) {
        return "অনুবাদ পাওয়া যায়নি।";
     }
     const prompt = `Translate this English text to natural Bengali (Bangla). Do not add explanations or notes. Just give the translated text:\n\n"${text}"`;
     const translated = await callGemini(prompt, "Translate English to Bengali clearly and naturally.");
     return translated || "অনুবাদ পাওয়া যায়নি।";
   }
    
    function cleanGeminiText(markdownText) {
        if (!markdownText || markdownText.includes("Could not retrieve")) return markdownText;
        let html = markdownText;
        html = html.replace(/\*\*(.+?)\*\*/g, '<b>$1</b>');
        html = html.replace(/(?<!\*)\*(?!\*)(.+?)(?<!\*)\*(?!\*)/g, '<i>$1</i>'); 
        html = html.replace(/\\_/g, '_'); 
        html = html.replace(/\\\*/g, '*'); 
        html = html.replace(/\\\\/g, '');
        html = html.replace(/\\([_#`~\[\]()])/g, '$1');
        html = html.replace(/^\s*\*\s?/gm, '• ');
        return html.trim();
    }

    function searchWord(word) {
      document.getElementById('wordInput').value = word;
      findWordFamily();
    }

    function clearHistory() {
      localStorage.removeItem('wordHistory');
      document.getElementById('results').style.display = 'none'; 
      loadHistory();
    }

    function loadHistory() {
      const historyContainer = document.getElementById('history-container');
      const initialStateDiv = document.getElementById('initial-state');
      const historyDiv = document.getElementById('history');
      const history = JSON.parse(localStorage.getItem('wordHistory') || '[]');
      const resultsVisible = document.getElementById('results').style.display !== 'none';

      if (history.length === 0) {
        historyContainer.style.display = 'none';
        if (!resultsVisible) {
           initialStateDiv.style.display = 'flex';
        }
        return;
      }

      initialStateDiv.style.display = 'none'; 
      historyContainer.style.display = 'block';
      historyDiv.innerHTML = '';
      history.forEach(word => {
        const item = document.createElement('span');
        item.className = 'history-item';
        item.textContent = word;
        item.onclick = () => searchWord(word);
        historyDiv.appendChild(item);
      });
    }

    function getInflectionsHtml(entry) {
        let inflections = [];
        if (entry.meanings) {
            entry.meanings.forEach(meaning => {
                if (meaning.definitions) {
                    meaning.definitions.forEach(definition => {
                        if (definition.inflections) {
                            definition.inflections.forEach(inflection => {
                                if (inflection.text) {
                                    const tag = inflection.grammaticalFeatures?.[0]?.type || meaning.partOfSpeech || 'Form';
                                    inflections.push({
                                        text: inflection.text,
                                        tag: tag.replace(/_/g, ' ')
                                    });
                                }
                            });
                        }
                    });
                }
            });
        }
        
        const uniqueInflections = Array.from(new Set(inflections.map(i => `${i.tag}:${i.text}`)))
                                    .map(str => {
                                        const [tag, text] = str.split(':');
                                        return {tag, text};
                                    });

        if (uniqueInflections.length === 0) return '';
        
        let html = '<div id="inflections">';
        uniqueInflections.forEach(inf => {
            html += `
                <span class="inflection-tag">
                    <span class="inflection-label">${inf.tag}:</span>
                    <b>${inf.text}</b>
                </span>
            `;
        });
        html += '</div>';
        return html;
    }

    function getSkeletonHtml() {
        const definitionLine = (width) => `
            <div class="skeleton-definition-item">
                <div class="skeleton-bullet"></div>
                <div class="skeleton-text-container">
                    <div class="skeleton-line" style="width: ${width};"></div>
                </div>
            </div>
        `;

        return `
            <div class="skeleton-screen">
                <div class="word-section">
                    <div class="skeleton-title skeleton-line"></div>
                    <div class="skeleton-big-text skeleton-line" style="width: 45%;"></div>
                </div>
                <div class="word-section">
                    <div class="skeleton-title skeleton-line" style="width: 50%;"></div>
                    <div class="skeleton-line" style="width: 90%;"></div>
                </div>
                <div class="word-section">
                    <div class="skeleton-title skeleton-line" style="width: 75%;"></div>
                    <div class="skeleton-line" style="width: 80%;"></div>
                    <div class="skeleton-line" style="width: 95%;"></div>
                    <div class="skeleton-line" style="width: 60%;"></div>
                </div>
                <div class="word-section">
                    <div class="skeleton-title skeleton-line" style="width: 65%;"></div>
                    <div class="skeleton-line" style="width: 80%;"></div>
                    <div class="skeleton-line" style="width: 95%;"></div>
                </div>
                <div class="word-section">
                    <div class="skeleton-title skeleton-line" style="width: 55%;"></div> 
                    <div class="skeleton-line" style="width: 90%;"></div>
                    <div class="skeleton-line" style="width: 70%;"></div>
                </div>
                <div class="word-section">
                  <div class="skeleton-title skeleton-line" style="width: 30%;"></div>
                  ${definitionLine('98%')}
                  ${definitionLine('60%')}
                  ${definitionLine('85%')}
                </div>
                <div class="word-section">
                    <div class="skeleton-title skeleton-line" style="width: 35%;"></div>
                    <div class="related" style="height: 40px; padding: 10px 15px;">
                        <div class="skeleton-line" style="width: 90%; margin: 0;"></div>
                    </div>
                </div>
            </div>
        `;
    }

    async function findWordFamily() {
      const word = document.getElementById("wordInput").value.trim().toLowerCase();
      const resultsDiv = document.getElementById("results");
      const initialStateDiv = document.getElementById("initial-state");
      
      if (window.speechSynthesis.speaking) {
          window.speechSynthesis.cancel();
          if (currentButton) {
             resetButtonVisuals(currentButton);
             currentButton = null;
          }
      }
      rawTextsForTTS = {};

      if (!word) {
        resultsDiv.style.display = "none";
        loadHistory();
        return;
      }

      initialStateDiv.style.display = "none";
      resultsDiv.innerHTML = getSkeletonHtml();
      resultsDiv.style.display = "block";
      let dictionaryFailed = false;

      try {
        const [dictRes, synRes, antRes, rawSummaryText, rawEtymologyText, rawGrammarText, rawFamilyForms] = await Promise.all([
          fetch(API_URL_DICT + word),
          fetch(API_URL_DM + `?rel_syn=${word}`),
          fetch(API_URL_DM + `?rel_ant=${word}`),
          getWordSummary(word), 
          getWordEtymology(word),
          getGrammarSummary(word),
          getWordFamilyForms(word), 
        ]);
        
        const summaryDisplay = cleanGeminiText(rawSummaryText);
        const etymologyDisplay = cleanGeminiText(rawEtymologyText);
        const grammarDisplay = cleanGeminiText(rawGrammarText);
        const familyFormsDisplay = cleanGeminiText(rawFamilyForms);

        const [rawBnSummary, rawBnEtymology, rawBnGrammar] = await Promise.all([
            getBengaliTranslation(rawSummaryText),
            getBengaliTranslation(rawEtymologyText),
            getBengaliTranslation(rawGrammarText)
        ]);
        
        const bnSummaryDisplay = cleanGeminiText(rawBnSummary);
        const bnEtymologyDisplay = cleanGeminiText(rawBnEtymology);
        const bnGrammarDisplay = cleanGeminiText(rawBnGrammar);

        const dictData = dictRes.ok ? await dictRes.json() : null;
        if (!dictRes.ok || dictRes.status === 404 || (Array.isArray(dictData) && dictData.length === 0)) {
            dictionaryFailed = true;
        }

        let synData = synRes.ok ? await synRes.json() : [];
        let antData = antRes.ok ? await antRes.json() : [];
        const entry = Array.isArray(dictData) ? dictData[0] : null; 
        const meanings = entry?.meanings || [];
        const originalWord = word;
        const baseWord = entry?.word || originalWord;
        const didFindBaseForm = entry && baseWord.toLowerCase() !== originalWord.toLowerCase();

        if (didFindBaseForm && baseWord !== originalWord) {
            const [baseSynRes, baseAntRes] = await Promise.all([
                fetch(API_URL_DM + `?rel_syn=${baseWord}`),
                fetch(API_URL_DM + `?rel_ant=${baseWord}`)
            ]);
            const baseSynData = baseSynRes.ok ? await baseSynRes.json() : [];
            const baseAntData = baseAntRes.ok ? await baseAntRes.json() : [];
            if (baseSynData.length > synData.length) synData = baseSynData;
            if (baseAntData.length > antData.length) antData = baseAntData;
        }

        const synonyms = [...new Set(synData.map(r => r.word))].filter(w => w !== baseWord && w !== originalWord).slice(0, 20);
        const antonyms = [...new Set(antData.map(r => r.word))].filter(w => w !== baseWord && w !== originalWord).slice(0, 20);

        if (entry || synonyms.length > 0 || antonyms.length > 0) {
            let history = JSON.parse(localStorage.getItem('wordHistory') || '[]');
            history = history.filter(h => h !== originalWord);
            history.unshift(originalWord);
            history = history.slice(0, 15); 
            localStorage.setItem('wordHistory', JSON.stringify(history));
            loadHistory(); 
        }

        rawTextsForTTS = {
            'summary-en': rawSummaryText, 
            'etymology-en': rawEtymologyText, 
            'grammar-en': rawGrammarText, 
            'summary-bn': rawBnSummary, 
            'etymology-bn': rawBnEtymology, 
            'grammar-bn': rawBnGrammar,
        };

        let html = `<div class="word-section"><h3>Word:</h3><p style="font-size: 1.5em; margin: 0;"><b>${baseWord}</b></p>`;
        if (didFindBaseForm) {
            html += `<p class="base-form-note">(Showing results for base form of <b>${originalWord}</b>)</p>`;
        }
        if (entry) {
            const phonetic = entry.phonetics?.find(p => p.audio && p.audio.length > 0);
            if (phonetic) {
              html += `<audio controls><source src="${phonetic.audio}" type="audio/mpeg">Your browser does not support audio.</audio>`;
            }
        }
        html += `</div>`;
        
        if (rawSummaryText && rawSummaryText !== "N/A" && !rawSummaryText.includes("Could not retrieve")) {
            html += `
                <div class="word-section">
                    <div class="section-header">
                        <h3>Concise Summary</h3>
                        <button class="read-aloud-btn" id="audio-summary-en" data-lang="en" 
                             onclick="readAloudBrowser(rawTextsForTTS['summary-en'], 'en', this)">
                             ${getSpeakerIconHtml()}
                        </button>
                    </div>
                    <p id="summaryText">${summaryDisplay}</p>
                    <a class="translate-toggle" 
                       onclick="const target = this.nextElementSibling; const isVisible = target.style.display === 'block'; target.style.display = isVisible ? 'none' : 'block'; this.innerText = isVisible ? 'See Bengali translation' : 'Hide Bengali translation';">
                        See Bengali translation
                    </a>
                    <div class="bengali-translation" style="display: none; margin-top: 10px;">
                        <div class="section-header" style="margin-bottom: 0;">
                            <p id="bnSummaryText" style="margin:0;">${bnSummaryDisplay}</p>
                            <button class="read-aloud-btn" id="audio-summary-bn" data-lang="bn" 
                                onclick="readAloudBrowser(rawTextsForTTS['summary-bn'], 'bn', this)">
                                ${getSpeakerIconHtml()}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        if (rawEtymologyText && rawEtymologyText !== "N/A" && !rawEtymologyText.includes("Could not retrieve")) {
            html += `
                <div class="word-section">
                    <div class="section-header">
                        <h3>Etymology (Origin)</h3>
                        <button class="read-aloud-btn" id="audio-etymology-en" data-lang="en" 
                             onclick="readAloudBrowser(rawTextsForTTS['etymology-en'], 'en', this)">
                             ${getSpeakerIconHtml()}
                        </button>
                    </div>
                    <p id="etymologyText">${etymologyDisplay}</p>
                    <a class="translate-toggle"
                       onclick="const target = this.nextElementSibling; const isVisible = target.style.display === 'block'; target.style.display = isVisible ? 'none' : 'block'; this.innerText = isVisible ? 'See Bengali translation' : 'Hide Bengali translation';">
                        See Bengali translation
                    </a>
                    <div class="bengali-translation" style="display: none; margin-top: 10px;">
                        <div class="section-header" style="margin-bottom: 0;">
                            <p id="bnEtymologyText" style="margin:0;">${bnEtymologyDisplay}</p>
                            <button class="read-aloud-btn" id="audio-etymology-bn" data-lang="bn" 
                                onclick="readAloudBrowser(rawTextsForTTS['etymology-bn'], 'bn', this)">
                                ${getSpeakerIconHtml()}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        if (rawGrammarText && rawGrammarText !== "N/A" && !rawGrammarText.includes("Could not retrieve")) {
            html += `
                <div class="word-section">
                    <div class="section-header">
                        <h3>Deep Grammar & Usage</h3>
                        <button class="read-aloud-btn" id="audio-grammar-en" data-lang="en" 
                             onclick="readAloudBrowser(rawTextsForTTS['grammar-en'], 'en', this)">
                             ${getSpeakerIconHtml()}
                        </button>
                    </div>
                    <p id="grammarText">${grammarDisplay}</p>
                    <a class="translate-toggle"
                       onclick="const target = this.nextElementSibling; const isVisible = target.style.display === 'block'; target.style.display = isVisible ? 'none' : 'block'; this.innerText = isVisible ? 'See Bengali translation' : 'Hide Bengali translation';">
                        See Bengali translation
                    </a>
                    <div class="bengali-translation" style="display: none; margin-top: 10px;">
                        <div class="section-header" style="margin-bottom: 0;">
                            <p id="bnGrammarText" style="margin:0;">${bnGrammarDisplay}</p>
                            <button class="read-aloud-btn" id="audio-grammar-bn" data-lang="bn" 
                                onclick="readAloudBrowser(rawTextsForTTS['grammar-bn'], 'bn', this)">
                                ${getSpeakerIconHtml()}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        if (rawFamilyForms && rawFamilyForms !== "N/A" && !rawFamilyForms.includes("Could not retrieve")) {
            html += `
                <div class="word-section">
                    <h3>Word Forms (Morphology)</h3>
                    <p id="wordFamilyFormsContent" class="pre-wrap-content">${familyFormsDisplay}</p> 
                </div>
            `;
        }

        if (entry) {
            html += getInflectionsHtml(entry);
        }

        if (entry) {
            for (let i = 0; i < meanings.length; i++) {
              const meaning = meanings[i];
              const part = meaning.partOfSpeech || "unknown";
              const capitalizedPart = part.charAt(0).toUpperCase() + part.slice(1);
              const defs = meaning.definitions
                .map(d => {
                  const cleanedDefinition = d.definition.replace(/\*/g, '"');
                  let defHtml = `<div class="definition-item"><span class="definition-text">${cleanedDefinition}</span>`;
                  if (d.example) {
                    defHtml += `<span class="example">e.g., "<i>${d.example}</i>"</span>`;
                  }
                  defHtml += `</div>`;
                  return defHtml;
                })
                .slice(0, 5) 
                .join(""); 
              html += `<div class="word-section"><h3>${capitalizedPart}</h3><div class="definition">${defs}</div></div>`;
            }
        } else if (dictionaryFailed) {
             if (synonyms.length > 0 || antonyms.length > 0) {
                html += `
                    <div class="word-section dictionary-missing">
                        <h3>Dictionary Entry Missing</h3>
                        <p class="no-entry-note" style="color: var(--fallback); font-weight: bold;">
                            The external dictionary database does not provide a formal definition for <b>"${originalWord}"</b>.
                        </p>
                        <p class="no-entry-note">We were able to find related words below.</p>
                    </div>
                `;
             } else {
                 html += `<p style="color:red; text-align:center;">No data is available for "${originalWord}" in the dictionary.</p>`;
             }
        }
        
        if (synonyms.length > 0) {
          html += `<div class="word-section"><h3>Synonyms</h3><div class="related">${synonyms.join(", ")}</div></div>`;
        }
        if (antonyms.length > 0) {
          html += `<div class="word-section"><h3>Antonyms</h3><div class="related">${antonyms.join(", ")}</div></div>`;
        }
        
        html += `<small style="color:gray; margin-top: 15px; display: block;">Sources: DictionaryAPI.dev, Datamuse API, & Gemini AI (for Summary/Etymology/Grammar/Morphology)</small>`;
        resultsDiv.innerHTML = html;

      } catch (error) {
        console.error("Fetch or data error:", error);
        resultsDiv.innerHTML = `<p style="color:red;">A critical error occurred while fetching data. (Error: ${error.message})</p>`;
      }
    }

    const tutorialContainer = document.getElementById('tutorial-container');
    const tutorialVideo = document.getElementById('tutorial-video');
    const muteToggle = document.getElementById('mute-toggle');
    let tutorialSrc = tutorialVideo ? tutorialVideo.src : null;

    const iconMute = `
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M11 5L6 9H2v6h4l5 4V5z"></path>
        <line x1="23" y1="9" x2="17" y2="15"></line>
        <line x1="17" y1="9" x2="23" y2="15"></line>
      </svg>`;
    const iconUnmute = `
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M11 5L6 9H2v6h4l5 4V5z"></path>
        <path d="M15.54 8.46a4.99 4.99 0 0 1 0 7.07"></path>
        <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
      </svg>`;

    let wasUnmutedBefore = localStorage.getItem('tutorialUnmuted') === 'true';

    window.addEventListener('load', () => {
      if (tutorialContainer) {
        const hasPlayedBefore = localStorage.getItem('tutorialPlayed') === 'true';
        
        if (hasPlayedBefore) {
          tutorialSrc = tutorialSrc.replace('autoplay=0', 'autoplay=1');
          tutorialVideo.src = tutorialSrc;
          muteToggle.style.display = 'flex';
        } else {
          localStorage.setItem('tutorialPlayed', 'true');
          muteToggle.style.display = 'flex';
        }
        
        if (tutorialSrc.includes('muted=1')) {
          muteToggle.innerHTML = iconMute;
        } else {
          muteToggle.innerHTML = iconUnmute;
        }
      }
    });

    if (muteToggle) {
      muteToggle.addEventListener('click', () => {
        if (!tutorialVideo || !tutorialSrc) return;
        if (tutorialSrc.includes('muted=1')) {
          tutorialSrc = tutorialSrc.replace('muted=1', 'muted=0');
          tutorialVideo.src = tutorialSrc;
          localStorage.setItem('tutorialUnmuted', 'true');
          muteToggle.innerHTML = iconUnmute;
          muteToggle.style.display = 'none';
        } else {
          tutorialSrc = tutorialSrc.replace('muted=0', 'muted=1');
          tutorialVideo.src = tutorialSrc;
          localStorage.setItem('tutorialUnmuted', 'false');
          muteToggle.innerHTML = iconMute;
          muteToggle.style.display = 'flex';
        }
      });
    }

    const originalFindWordFamily = findWordFamily;
    findWordFamily = async function() {
      const word = document.getElementById("wordInput").value.trim().toLowerCase();
      if (word && tutorialContainer) {
        if (tutorialVideo) tutorialVideo.src = ''; 
        tutorialContainer.style.display = 'none';
      }
      await originalFindWordFamily();
    };

    const originalClearHistory = clearHistory;
    clearHistory = function() {
      originalClearHistory();
      if (tutorialContainer) {
        tutorialContainer.style.display = 'block';
        tutorialVideo.src = tutorialSrc;
      }
    };
  </script>
</body>
</html>

